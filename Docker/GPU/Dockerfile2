######################################################################
#  ROS 2 Humble · CUDA 12.4 · Ubuntu 22.04 · RealSense · Gazebo 11   #
######################################################################
FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

########################## 基本環境變數 ##############################
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Taipei \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    ROS_DISTRO=humble \
    NB_USER=hrc \
    NB_UID=1000 \
    SHELL=/bin/bash

############################ 建立使用者 ###############################
RUN adduser --disabled-password --gecos "Default user" --uid ${NB_UID} ${NB_USER} \
 && echo "root:root"           | chpasswd \
 && echo "${NB_USER}:111111"   | chpasswd
ENV HOME=/home/${NB_USER}

########################## 基本工具與 Python ##########################
RUN apt-get -q update && apt-get -yq dist-upgrade && \
    apt-get -yq install --no-install-recommends \
    curl wget git sudo vim gedit cmake build-essential tzdata lsb-release \
    ca-certificates gnupg2 locales dirmngr net-tools software-properties-common \
    python3 python3-pip python3-venv python3-dev python3-setuptools python3-yaml \
    bash-completion xterm scrot \
    libx11-dev xorg-dev libgl1-mesa-dev libglu1-mesa-dev \
    libusb-1.0-0-dev libjpeg-dev libpng-dev libtiff5-dev \
    libxinerama-dev libxft-dev libgtk-3-0 qtbase5-dev \
 && rm -rf /var/lib/apt/lists/*

# 時區
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

############################## ROS 2 源 ###############################
RUN apt-get update && apt-get install -y curl gnupg2 && \
    curl -fsSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
      -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
      http://packages.ros.org/ros2/ubuntu $(lsb_release -sc) main" \
      > /etc/apt/sources.list.d/ros2.list

############################## Gazebo 11 ##############################
# ===== 清掉舊 Gazebo *.list，避免 NO_PUBKEY =====
RUN rm -f /etc/apt/sources.list.d/gazebo*.list || true

# ===== 重新建立 keyring 與 .sources =====
RUN set -eux; \
  install -d -m 0755 /etc/apt/keyrings; \
  curl -fsSL https://packages.osrfoundation.org/gazebo.key \
    -o /etc/apt/keyrings/gazebo-archive-keyring.gpg; \
  cat > /etc/apt/sources.list.d/gazebo-classic.sources <<EOF
Types: deb
URIs: http://packages.osrfoundation.org/gazebo/ubuntu-stable
Suites: $(lsb_release -sc)
Components: main
Signed-By: /etc/apt/keyrings/gazebo-archive-keyring.gpg
EOF/etc/apt/keyrings/gazebo-archive-keyring.gpg
EOF

############################ 安裝 ROS 2 ###############################
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-${ROS_DISTRO}-desktop-full \
    ros-${ROS_DISTRO}-rosbridge-server \
    ros-${ROS_DISTRO}-gazebo-ros-pkgs ros-${ROS_DISTRO}-gazebo-ros \
    ros-${ROS_DISTRO}-joy ros-${ROS_DISTRO}-teleop-twist-joy ros-${ROS_DISTRO}-teleop-twist-keyboard \
    ros-${ROS_DISTRO}-tf2-tools ros-${ROS_DISTRO}-image-view ros-${ROS_DISTRO}-stereo-image-proc \
    ros-${ROS_DISTRO}-pointcloud-to-laserscan ros-${ROS_DISTRO}-rviz2 \
    ros-${ROS_DISTRO}-rqt ros-${ROS_DISTRO}-rqt-common-plugins ros-${ROS_DISTRO}-rqt-robot-steering \
    ros-${ROS_DISTRO}-xacro python3-rosdep python3-colcon-common-extensions python3-argcomplete \
 && rm -rf /var/lib/apt/lists/*

# rosdep
RUN rosdep init || true && rosdep update

########################## ros2_control & MoveIt2 #####################
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-${ROS_DISTRO}-ros2-control ros-${ROS_DISTRO}-ros2-controllers \
    ros-${ROS_DISTRO}-joint-state-publisher-gui ros-${ROS_DISTRO}-moveit \
 && rm -rf /var/lib/apt/lists/*

########################## Intel RealSense ############################
RUN install -d -m 0755 /etc/apt/keyrings && \
    curl -fsSL https://librealsense.intel.com/Debian/librealsense.pgp \
      -o /etc/apt/keyrings/librealsense.pgp && \
    cat > /etc/apt/sources.list.d/librealsense.sources <<EOF
Types: deb
URIs: https://librealsense.intel.com/Debian/apt-repo
Suites: $(. /etc/os-release && echo $UBUNTU_CODENAME)
Components: main
Signed-By: /etc/apt/keyrings/librealsense.pgp
EOF

RUN apt-get update && apt-get install -y --no-install-recommends \
    librealsense2-dkms librealsense2-utils librealsense2-dev \
    ros-${ROS_DISTRO}-realsense2-camera \
 && rm -rf /var/lib/apt/lists/*

#################### 其他機器人/常用函式庫 ############################
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-${ROS_DISTRO}-geographic-msgs ros-${ROS_DISTRO}-geodesy \
    ros-${ROS_DISTRO}-ddynamic-reconfigure ros-${ROS_DISTRO}-dynamixel-sdk \
 && rm -rf /var/lib/apt/lists/*

########################## Python 套件 + PyTorch ######################
RUN python3 -m pip install --upgrade pip setuptools wheel && \
    pip3 install \
      matplotlib pandas requests jupyter jupyter_http_over_ws \
      rospkg catkin-tools scikit-image scikit-learn zerorpc gdown \
      pybind11-global seaborn roma openai roslibpy modern_robotics && \
    pip3 install --index-url https://download.pytorch.org/whl/cu121 \
      torch==2.4.0+cu121 torchvision==0.19.0+cu121 && \
    pip3 install mkdocs mkdocs-with-pdf mkdocstrings mkdocs-material "mkdocstrings[python]"

############################ 桌面輔助工具 ##############################
RUN apt-get update && apt-get install -y --no-install-recommends xdotool wmctrl \
 && rm -rf /var/lib/apt/lists/*

############################## 其他設定 ###############################
RUN echo "root ALL=(ALL) ALL" >> /etc/sudoers && \
    echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> ${HOME}/.bashrc

ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=all

############################ 切換到一般用戶 ###########################
USER ${NB_USER}
WORKDIR ${HOME}
